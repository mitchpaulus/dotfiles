#!/usr/bin/env mshell
$REPOS? not ("REPOS environment variable not set" wl 1 exit) iff
$"Refreshing {$REPOS}" wle

def process-repo (--)
    absPath dir!
    $"Fetching {@dir}.." wle
    [git -C @dir fetch --prune]? if
        # Check if git status --porcelain is empty
        [git -C @dir status --porcelain]? if
            # Clean
            $"Refreshing {@dir}.." wle
            [git -C @dir merge --ff-only];
        else
            $"Skipping {@dir}.." wle # Not clean
        end
    else
        "Could not fetch repo, maybe internet or bad remote?" wle
    end
end

$REPOS lsDir (isDir) filter (process-repo) each
